# 變更記錄（CHANGELOG）

遵循 Keep a Changelog 格式，並建議使用 Semantic Versioning（SemVer）。

## [Unreleased]
- 待記錄的變更（尚未釋出）。

## [1.4.3] - 2026-03-01
### 新增
- **日期輸入驗證與重試機制**：當使用者輸入錯誤的日期格式時，系統不再直接使用預設值，而是要求重新輸入。
- 新增結束日期不得早於起始日期的邏輯驗證。

### 改進
- 改善使用者體驗，提供明確的錯誤提示訊息（✗ 日期格式錯誤！）。
- 成功輸入時顯示確認訊息（✓）。
- 使用者可選擇按 Esc 取消輸入並使用系統預設值（24小時）。
- 重試循環確保資料準確性，避免因輸入錯誤而執行錯誤的查詢範圍。

### 修正
- 修正編譯錯誤 CS0103：使用 `usedEscape` 布林變數追蹤 Esc 按鍵狀態，取代區域變數 `fromDateStr` 的作用域問題。
- 修正編譯錯誤 CS0165：在宣告時初始化 `fromDate` 和 `toDate` 變數為預設值（24小時），確保所有執行路徑都有明確賦值。

## [1.4.2] - 2026-03-01
### 修正
- **重要修正**：修正當使用者選擇 No 或按 Esc 時，系統錯誤地返回原始查詢而不是使用24小時預設值的問題。
- 現在的行為：
  - **Yes**：進入自訂模式，讓使用者輸入日期（或按 Enter 使用24小時）
  - **No/Esc**：直接使用系統時間起算24小時，不再詢問
- 增加提示訊息，明確顯示所使用的日期範圍。

## [1.4.1] - 2026-03-01
### 改進
- 修改日期範圍預設值從「最近 15 天」改為「系統時間起算24小時」。
- 更新提示文字：從「使用查詢語句中的預設值」改為「使用系統時間起算24小時」。
- 日期顯示格式增加時間部分，提供更精確的時間範圍資訊。

## [1.3.4] - 2026-02-28
### 改進
- 進度條時間顯示改為「已執行時間」，使用 `ElapsedTimeColumn` 取代 `RemainingTimeColumn`。
- 移除不準確的剩餘時間預估，改為顯示實際已執行時長，提供更直觀的進度資訊。

## [1.4.0] - 2026-02-28
### 新增
- **日期範圍自訂功能**：執行導出前可動態輸入日期範圍，無需修改查詢語句。
- 自動偵測查詢中的 `@timestamp` range 條件，提示使用者是否自訂。
- 支援多種日期格式輸入：`2026-02-20` 或 `2026-02-20T10:30:00`。
- 提供預設值選項：按 Enter 使用最近 15 天的資料。
- 智能替換：遞迴搜尋並替換 JSON 查詢結構中的日期值。

### 改進
- 使用者可在每次導出時靈活調整時間範圍，提升操作便利性。
- 日期輸入介面友善，提供格式提示與預設值說明。

### 修正
- 修正日期輸入提示中方括號導致 Spectre.Console markup 解析錯誤的問題。

## [1.3.3] - 2026-02-28
### 改進
- 進度條改用粗體 ASCII 字符：已完成使用 `█` (實心方塊)，未完成使用 `░` (淺色陰影)。
- 創建 `CustomProgressBarColumn` 自訂進度條欄位，大幅提升視覺辨識度。
- 解決細線進度條不明顯的問題，色彩對比更清晰。

## [1.3.2] - 2026-02-28
### 改進
- 進度條視覺大幅優化：加寬至 50 字元，使用彩色樣式（綠色已完成 / 灰色未完成）。
- 新增傳輸速度顯示欄位，提供更完整的下載資訊。
- 優化任務描述文字樣式為粗體青色，提升視覺識別度。

## [1.3.1] - 2026-02-28
### 改進
- `DataStreamer.cs` 檔案添加版本歷程註記，同步至 v1.3.0。
- 優化資料導出進度條顯示：加寬進度條至 40 字元，添加已下載筆數顯示，改用更明顯的動畫效果。
- 設定進度條自動刷新與保留完成狀態，提升使用者體驗。

### 技術改進
- 在 `DataStreamer.ExportAsync()` 中使用 `QueryString` 參數正確傳遞 scroll 超時設定，解決 LowLevel API 的 TimeSpan 類型轉換問題。

## [1.3.0] - 2026-02-28
### 改進
- 改進連線驗證方法 4：使用實際查詢（match_all, size=0）取代 `Indices.Exists` 檢查。
- 解決只有 `indices:data/read/search` 查詢權限但無 `indices:admin/get` 管理權限的使用者連線驗證失敗問題。
- 驗證成功時明確提示「您有查詢權限，可以正常使用導出功能」。

### 修正
- `DataStreamer.ExportAsync()` 應用智能查詢包裝機制，修正資料導出時的查詢雙重包裝問題。
- 完整 DSL 查詢使用 LowLevel API 直接發送，簡單查詢條件使用 High-Level API 包裝。
- 解決從 OpenSearch Dashboard 複製的完整 DSL 無法正常導出資料的問題。

## [1.2.1] - 2026-02-28
### 修正
- 修正查詢管理界面長查詢顯示問題：限制查詢預覽最多顯示 15 行，超過時顯示省略提示。
- 同時修正「查詢選擇」和「查詢編輯」兩處界面的顯示問題。
- 避免長查詢（如從 OpenSearch Dashboard 複製的完整 DSL）導致編輯選項被推出螢幕外看不到。

## [1.2.0] - 2026-02-28
### 修正
- `TestQuery()` 修正對完整查詢 DSL 進行二次包裝的問題，避免將 sort、size、aggs 等頂層字段錯誤包裝在 `{"query": ...}` 內。
- 智能偵測查詢結構：檢查頂層是否包含 "query" 字段，若有則直接使用原始查詢，若無則自動包裝為標準請求格式。
- 支援從 OpenSearch Dashboard 複製的完整查詢 DSL（包含 sort、size、aggs、highlight 等複雜結構）。

### 改進
- `TestQuery()` 增加 Debug 日誌記錄查詢處理方式，方便診斷。

## [1.1.0] - 2026-02-28
### 新增
- 新增四種連線驗證方式自動切換機制：
  1. Ping (HEAD /)
  2. Cluster Health (GET /_cluster/health)
  3. Root (GET /)
  4. Index 存在檢查 (HEAD /{index}) - 特別適用於只有 Index 層級權限的使用者
- 新增帳號格式自動偵測與修正：自動偵測 Windows 域名格式（如 `domain\user`），提供互動式選項移除域名前綴。
- 新增 PowerShell 獨立測試腳本 `Scripts/Test-OpenSearchConnection.ps1`，可直接測試 OpenSearch 連線，排除應用程式邏輯問題。

### 改進
- 智慧型 403 錯誤診斷：區分「認證失敗」與「權限不足」兩種情況。
- 自動偵測 `security_exception` 並判斷為權限問題，顯示「✓ 帳號密碼正確，已通過認證」確認訊息。
- 提供精確的解決方案：列出需要的具體權限（如 `cluster:monitor/health`），建議聯繫管理員或使用更高權限帳號。
- 401 錯誤提供認證失敗的可能原因；自動偵測 SSL 相關錯誤並提供額外提示。
- 改善日誌記錄：記錄 `IgnoreSslErrors` 狀態、每種驗證方法的嘗試結果和 HTTP 狀態碼。
- 優化使用者體驗：在帳號輸入界面添加格式提示，連線成功時顯示使用的驗證方法，錯誤訊息更加結構化。

### 修正
- 修正命名空間衝突：明確指定 `OpenSearch.Net.HttpMethod` 避免與 `System.Net.Http.HttpMethod` 衝突。
- 改善連線可靠性：當 HEAD / 請求被拒絕（403）時嘗試其他端點，提高在 OpenSearch Security Plugin 嚴格安全設定下的連線成功率。

### 驗證場景
- OpenSearch Security Plugin 環境
- 使用者具有 backend_roles 但缺少 cluster 權限
- 自動識別 `security_exception` 類型錯誤
- Index 層級權限檢查
- 從 OpenSearch Dashboard 複製的完整查詢 DSL
- 包含 sort、size、aggs、highlight 等複雜查詢結構

---

使用說明：
- 每次主要釋出或合併重大變更時，請於頂端的 Unreleased 區段記錄變更，並在釋出時移入新版本章節。
- 建議條目類型：新增（Added）、修正（Fixed）、改進（Changed）、移除（Removed）、重構（Refactored）、驗證場景（Validated Scenarios）。

範例格式：
- 新增: 新功能描述
- 修正: 修補 bug 描述
- 改進: 效能或可維護性改善描述

維護者：請在每次重要變更時同步更新此檔案。
