# OSDX (OpenSearch Data Xport) 操作使用手冊

**OSDX** 是一個專為 OpenSearch 打造的自動化資料匯出工具，採用 .NET 8 開發。它旨在解決海量資料（50 萬筆以上）匯出時的穩定性問題，並提供友善的交互式終端介面 (TUI) 與自動化支援。

---

## 1. 快速入門

### 執行環境
*   **作業系統**：Windows 11 / Linux (如 Ubuntu 22.04+)。
*   **連線要求**：需能存取目標 OpenSearch 叢集的 REST API (預設埠號 9200)。

### 啟動程式
在終端機 (PowerShell, CMD 或 Bash) 中執行：
```bash
./osdx
```
*   若直接執行且不帶參數，將進入 **「交互式引導模式 (TUI)」**。
*   程式啟動時會讀取同目錄下的 `config.json` 設定檔。

---

## 2. 核心使用流程 (Step-by-Step)

為了確保操作順利，請遵循以下標準作業流程：

### 步驟 1：建立或檢查設定檔 (Profile)
*   第一次使用時，請先進入 **「3. 管理設定檔」** 建立連線目標（URL、Index）。
*   若已有設定檔，請確認 **「管理查詢語句 (Queries)」** 中已定義正確的查詢條件。

### 步驟 2：執行連線與身份驗證 (必要前提)
*   **關鍵操作**：在主選單選擇 **「1. 連線資訊選擇 (切換目標)」**。
*   **目的**：輸入帳密並通過伺服器驗證。
*   **注意**：**「2. 開始執行資料導出」** 功能在連線成功前是鎖定的。若未完成此步驟，程式會提示連線錯誤。

### 步驟 3：執行導出
*   當畫面頂端顯示 **[green]● 連線就緒[/]** 後，即可進入 **「2. 開始執行資料導出」**。
*   挑選查詢語句後，程式便會開始分批抓取資料並寫入檔案。

---

## 3. 交互式引導模式 (TUI) 操作

啟動後您將看到主選單，使用鍵盤 **方向鍵 (↑/↓)** 選擇，**Enter** 確認，**Esc** 返回上層。

### 2.1 連線資訊選擇 (切換目標)
在執行導出前，必須先建立並驗證連線。
1.  選擇 **「1. 連線資訊選擇 (切換目標)」**。
2.  從已儲存的設定檔清單中挑選一個目標。
3.  輸入 **帳號 (Username)** 與 **密碼 (Password)**。
    *   *提示：密碼輸入時會以星號 (*) 遮蔽。*
4.  系統將立即驗證連線。驗證成功後，主畫面頂部會顯示綠色的連線就緒狀態。

### 2.2 開始執行資料導出
1.  確保主畫面已顯示「連線就緒」。
2.  選擇 **「2. 開始執行資料導出」**。
3.  若該設定檔擁有多個查詢語句 (Queries)，請挑選要使用的一組。
4.  程式將顯示進度條，實時呈現：
    *   **已匯出筆數 / 總預估筆數**
    *   **進度百分比**
    *   **預估剩餘時間**
5.  導出完成後，系統會顯示最終報告，包含檔案路徑、總筆數、總耗時與檔案大小。

### 2.3 管理設定檔 (編輯/建立/刪除)
您可以維護多組常用的連線與導出設定：
*   **建立新設定檔**：輸入 OpenSearch URL、Index 名稱、預設帳號與設定檔別名。
*   **修改連線資訊**：調整目標 URL、Index 或帳號。
*   **修改導出設定**：
    *   **Format**：切換 `csv` 或 `json`。
    *   **Fields**：指定要匯出的欄位（逗號分隔），留空則匯出所有欄位。
    *   **BatchSize**：每批次抓取的數量（建議 2000~5000）。
    *   **OutputPath**：指定檔案存儲路徑。
*   **管理查詢語句 (Queries)**：每個設定檔可以擁有多組具名的 Query DSL。

### 2.4 管理查詢語句 (Queries)
OSDX 支援強大的查詢語法編輯與測試：
1.  進入 **「管理查詢語句清單」**。
2.  **編輯內容**：
    *   **快速模板**：快速產生 `match_all` 語法。
    *   **直接輸入**：在終端機貼上 JSON 片段。
    *   **外部編輯器**：調用系統預設編輯器（Windows 呼叫 `notepad`，Linux 呼叫 `vim` 或 `$EDITOR`）編輯複雜 JSON。
3.  **語法測試**：儲存後可選擇「立即對伺服器進行語法測試」，系統會發送一個小型請求至 OpenSearch，確認您的 JSON 語法是否被伺服器接受。

---

## 3. 系統設定
在主選單選擇 **「4. 系統設定」**：
*   **Global Ignore SSL Errors**：若您的 OpenSearch 使用自簽憑證 (HTTPS)，請開啟此項以避免連線失敗。
*   **Log Level**：調整日誌詳細度（Verbose, Debug, Information 等）。

---

## 4. 設定檔說明 (`config.json`)

`config.json` 存儲了所有設定資訊。範例如下：

```json
{
  "Profiles": {
    "Prod-Logs": {
      "Connection": {
        "Endpoint": "https://localhost:9200",
        "Index": "web-logs-*",
        "Username": "admin",
        "IgnoreSslErrors": true
      },
      "Export": {
        "Format": "csv",
        "Fields": ["@timestamp", "ip", "status"],
        "BatchSize": 5000,
        "OutputPath": "./exports/",
        "ScrollTimeout": "2m"
      },
      "Queries": {
        "All-Data": { "match_all": {} },
        "Errors": { "term": { "status": 500 } }
      }
    }
  },
  "Settings": {
    "LogLevel": "Information",
    "GlobalIgnoreSslErrors": true
  }
}
```

---

## 5. 常見問題與提示 (FAQ)

### Q1: 為什麼 CSV 匯出的欄位不齊全？
**A**: 若您未指定 `Fields`，OSDX 會掃描第一批次資料的鍵值作為標頭。若您的索引資料結構高度異質（不同文件的欄位差異極大），建議在 `Fields` 中明確列出所有需要的欄位名稱。

### Q2: 匯出超大型資料時程式中斷怎麼辦？
**A**:
1.  檢查磁碟空間是否充足。
2.  檢查日誌檔案 (`logs/osdx-yyyyMMdd.log`) 確認錯誤原因。
3.  若是網路不穩定導致，可嘗試增加 `ScrollTimeout`（例如改為 `5m`）。

### Q3: 密碼安全性？
**A**: 目前 `config.json` 不儲存密碼。每次啟動連線時，程式會要求您輸入密碼。這能確保設定檔即便外洩，也不會直接曝露敏感憑證。

### Q4: 輸出的 JSON 格式為何？
**A**: OSDX 匯出的 JSON 採用 **JSON Lines (LDJSON)** 格式，即每行一個獨立的 JSON 物件。這有利於後續使用 `jq` 或其它串流處理工具解析，且能大幅降低大型檔案的讀取負荷。

---

## 6. 技術支援
*   **日誌位置**：`logs/osdx-*.log`
*   **專案維護**：Robbin Lee (2026-02-18)
